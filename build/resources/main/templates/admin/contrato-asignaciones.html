<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignaciones de Contrato</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Select2 para búsqueda en selects -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- CSS personalizado combinado -->
    <link href="/css/asignaciones.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar (incluir el fragment de menú) -->
    <div th:insert="fragments/menuPrincipal :: menu-principal"></div>
    
    <!-- Main Content -->
    <div class="main-area">
        <!-- Header Section -->
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/admin/contratos">Contratos</a></li>
                            <li class="breadcrumb-item active">Asignaciones</li>
                        </ol>
                    </nav>
                    <h2 class="mb-1">
                        <i class="fas fa-file-contract text-primary me-2"></i>
                        <span id="contratoCodigo">CONT-2024-001</span>
                    </h2>
                    <p class="text-muted mb-0" id="contratoObjetivo">Objetivo del contrato</p>
                </div>
                <button class="btn btn-secondary" onclick="window.history.back()">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </button>
            </div>
            
            <!-- Contract Info -->
            <div class="row g-3">
                <div class="col-md-3">
                    <small class="text-muted d-block">Zonas Configuradas</small>
                    <strong id="totalZonas">--</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Periodo</small>
                    <strong id="contratoPeriodo">--</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Estado</small>
                    <span class="badge bg-success" id="contratoEstado">Activo</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Progreso General</small>
                    <div class="assignment-progress">
                        <div class="assignment-progress-bar" id="progresoGeneral" style="width: 0%"></div>
                    </div>
                    <small class="text-muted"><span id="porcentajeProgreso">0</span>% completado</small>
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="container-fluid px-4">
            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="stats-badge mb-2">
                            <i class="fas fa-layer-group me-1"></i>
                            <span id="totalZonasStats">0</span>
                        </div>
                        <p class="text-muted mb-0">Zonas Activas</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="stats-badge mb-2">
                            <i class="fas fa-home me-1"></i>
                            <span id="totalPredios">0</span>
                        </div>
                        <p class="text-muted mb-0">Total Predios</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="stats-badge mb-2">
                            <i class="fas fa-users me-1"></i>
                            <span id="totalCoordinadores">0</span>
                        </div>
                        <p class="text-muted mb-0">Coordinadores</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="stats-badge mb-2">
                            <i class="fas fa-hard-hat me-1"></i>
                            <span id="totalOperarios">0</span>
                        </div>
                        <p class="text-muted mb-0">Operarios</p>
                    </div>
                </div>
            </div>
            
            <!-- Supervisor Assignment -->
            <div class="assignment-card" id="supervisorCard">
                <div class="assignment-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tie me-2"></i>Supervisor del Contrato
                    </h5>
                </div>
                <div class="assignment-body">
                    <div id="supervisorInfo">
                        <p class="text-muted">No hay supervisor asignado</p>
                    </div>
                    <button class="btn btn-sm btn-gradient" onclick="abrirModalSupervisor()" 
                            id="btnAsignarSupervisor">
                        <i class="fas fa-plus me-1"></i>Asignar Supervisor
                    </button>
                </div>
            </div>
            
            <!-- Zones Management -->
            <div class="assignment-card">
                <div class="assignment-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group me-2"></i>Gestión por Zonas
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-info me-2" onclick="verEstadisticasZonas()">
                                <i class="fas fa-chart-bar me-1"></i>Estadísticas
                            </button>
                            <button class="btn btn-sm btn-gradient" onclick="abrirModalAgregarZona()"
                                    id="btnAgregarZona">
                                <i class="fas fa-plus me-1"></i>Agregar Zona
                            </button>
                        </div>
                    </div>
                </div>
                <div class="assignment-body">
                    <div id="zonasContrato">
                        <p class="text-muted">Cargando zonas del contrato...</p>
                    </div>
                </div>
            </div>
            
            <!-- Operators and Properties Assignment -->
            <div class="assignment-card">
                <div class="assignment-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-hard-hat me-2"></i>Operarios y Predios
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="verTodosPredios()">
                                <i class="fas fa-list me-1"></i>Ver Todos
                            </button>
                            <button class="btn btn-sm btn-gradient" onclick="abrirModalAsignacionMasiva()"
                                    id="btnAsignacionMasiva">
                                <i class="fas fa-users-cog me-1"></i>Asignación Masiva
                            </button>
                        </div>
                    </div>
                </div>
                <div class="assignment-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mb-3">Operarios Disponibles</h6>
                            <div id="operariosDisponiblesList" class="overflow-auto" style="max-height: 400px;">
                                <!-- Lista de operarios -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="mb-3">Predios del Contrato</h6>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscarPredio" 
                                       placeholder="Buscar predio por dirección o código...">
                            </div>
                            <div id="prediosList" class="overflow-auto" style="max-height: 400px;">
                                <!-- Lista de predios -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Asignar Supervisor -->
    <div class="modal fade" id="modalSupervisor" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-user-tie me-2"></i>Asignar Supervisor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Seleccionar Supervisor</label>
                        <select class="form-select" id="selectSupervisor" style="width: 100%;">
                            <option value="">Seleccione un supervisor...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="asignarSupervisor()">
                        <i class="fas fa-save me-1"></i>Asignar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Agregar/Editar Zona -->
    <div class="modal fade" id="modalZona" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-layer-group me-2"></i>
                        <span id="modalZonaTitle">Agregar Zona al Contrato</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="zonaForm">
                        <input type="hidden" id="zonaUuidHidden">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Zona <span class="text-danger">*</span></label>
                                <select class="form-select" id="selectZona" required>
                                    <option value="">Seleccionar zona...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Plan de Tarifa <span class="text-danger">*</span></label>
                                <select class="form-select" id="selectPlanTarifa" required>
                                    <option value="">Seleccionar plan...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Coordinador de Zona</label>
                                <select class="form-select" id="selectCoordinadorZona">
                                    <option value="">Sin asignar</option>
                                </select>
                                <div class="form-text">Responsable de la gestión estratégica de la zona</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Coordinador Operativo</label>
                                <select class="form-select" id="selectCoordinadorOperativo">
                                    <option value="">Sin asignar</option>
                                </select>
                                <div class="form-text">Responsable de las operaciones diarias en la zona</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="selectEstadoZona">
                                    <option value="ACTIVO">Activo</option>
                                    <option value="EN_PROCESO">En Proceso</option>
                                    <option value="COMPLETADO">Completado</option>
                                    <option value="SUSPENDIDO">Suspendido</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarZona()">
                        <i class="fas fa-save me-1"></i>
                        <span id="btnGuardarZonaText">Agregar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Asignar Coordinador a Zona -->
    <div class="modal fade" id="modalCoordinadorZona" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>
                        <span id="modalCoordinadorTitle">Asignar Coordinador</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Zona</label>
                        <input type="text" class="form-control" id="zonaSeleccionada" readonly>
                        <input type="hidden" id="zonaUuidCoordinador">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Coordinador</label>
                        <select class="form-select" id="tipoCoordinador">
                            <option value="zona">Coordinador de Zona</option>
                            <option value="operativo">Coordinador Operativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar Coordinador</label>
                        <select class="form-select" id="selectCoordinadorModal" style="width: 100%;">
                            <option value="">Seleccione un coordinador...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info text-white" onclick="asignarCoordinadorAZona()">
                        <i class="fas fa-plus me-1"></i>Asignar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Asignación Individual -->
    <div class="modal fade" id="modalAsignarOperario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-check me-2"></i>Asignar Operario a Predio
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Predio</label>
                        <input type="text" class="form-control" id="predioSeleccionado" readonly>
                        <input type="hidden" id="predioUuid">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar Operario</label>
                        <select class="form-select" id="selectOperario" style="width: 100%;">
                            <option value="">Seleccione un operario...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="asignarOperarioAPredio()">
                        <i class="fas fa-save me-1"></i>Asignar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Asignación Masiva -->
    <div class="modal fade" id="modalAsignacionMasiva" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog me-2"></i>Asignación Masiva de Operarios
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Seleccione múltiples predios y asígnelos a uno o varios operarios
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Predios Sin Asignar</h6>
                            <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                <div id="prediosSinAsignarList">
                                    <!-- Lista de checkboxes de predios -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Operarios</h6>
                            <select class="form-select" id="selectOperarioMasivo" multiple style="height: 300px;">
                                <!-- Opciones de operarios -->
                            </select>
                            <small class="text-muted">Mantenga Ctrl para seleccionar múltiples</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="realizarAsignacionMasiva()">
                        <i class="fas fa-save me-1"></i>Asignar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- JavaScript personalizado -->
    <script src="/js/asignaciones.js"></script>
</body>
</html>